# ============================================================================
# バックエンド同期データ仕様
# GraphQL（静的データ） vs WebSocket（リアルタイムデータ）
# ============================================================================

# ============================================================================
# 📊 GraphQL - 静的データ（HTTP通信）
# ============================================================================

# --- 認証・ユーザー情報 ---
class AuthData:
	var token: String           # JWTトークン
	var user_id: String
	var username: String
	var email: String
	var character_id: int       # 選択中キャラクター
	var created_at: String
	var last_login: String

# GraphQLクエリ例
"""
query GetUserInfo($token: String!) {
  user_info(token: $token) {
    user_id
    username
    email
    character_id
    last_login
  }
}

mutation UpdateUserCharacter($user_id: String!, $character_id: Int!) {
  update_user_character(user_id: $user_id, character_id: $character_id) {
    success
  }
}
"""

# --- ルーム情報 ---
class RoomStaticData:
	var room_id: String
	var room_name: String
	var room_type: String       # "PUBLIC", "PRIVATE", "GROUP"
	var owner_id: String
	var description: String
	var map_scene_path: String
	var max_players: int
	var is_password_protected: bool
	var created_at: String

# GraphQLクエリ例
"""
query GetRooms {
  public_rooms {
    room_id
    room_name
    description
    current_players
    max_players
    map_scene_path
  }
  
  user_private_rooms(user_id: $user_id) {
    room_id
    room_name
    owner_id
  }
}

mutation CreatePrivateRoom($input: CreateRoomInput!) {
  create_private_room(input: $input) {
    success
    room_info { room_id room_name }
    error_message
  }
}
"""

# --- 研修システムデータ ---
class TrainingData:
	var training_id: String
	var title: String
	var url: String             # 外部ブラウザで開くURL
	var category: String
	var difficulty: String
	var estimated_time: int     # 分

class TrainingProgressData:
	var user_id: String
	var training_id: String
	var status: String          # "not_started", "in_progress", "completed"
	var score: int
	var completed_at: String

# GraphQLクエリ例
"""
query GetTrainingList($user_id: String!) {
  trainings {
    training_id
    title
    url
    category
    difficulty
    estimated_time
  }
  
  user_progress(user_id: $user_id) {
    training_id
    status
    score
    completed_at
  }
}

mutation UpdateTrainingProgress($input: TrainingProgressInput!) {
  update_training_progress(input: $input) {
    success
  }
}
"""

# --- チャット履歴（初期取得のみ） ---
class ChatHistoryData:
	var messages: Array[Dictionary] # 過去のメッセージ履歴
	var room_id: String
	var limit: int = 50

# GraphQLクエリ例  
"""
query GetChatHistory($room_id: String!, $limit: Int!) {
  chat_history(room_id: $room_id, limit: $limit) {
    user_id
    username
    message
    timestamp
    message_type
  }
}
"""

# ============================================================================
# 🔄 WebSocket - リアルタイムデータ（双方向通信）
# ============================================================================

# --- プレイヤー位置・状態同期 ---
class PlayerPositionSync:
	var user_id: String
	var position: Vector3
	var rotation: Vector3
	var velocity: Vector3       # 移動予測用
	var animation_state: int    # AnimationStates.State
	var timestamp: float
	var room_id: String

# WebSocketメッセージ例
"""
// 送信（Godot → サーバー）
{
  "type": "player_position_update",
  "room_id": "room_123",
  "user_id": "user_456",
  "data": {
    "position": {"x": 10.5, "y": 0.0, "z": 5.2},
    "rotation": {"x": 0.0, "y": 1.57, "z": 0.0},
    "velocity": {"x": 0.0, "y": 0.0, "z": 2.5},
    "animation_state": 1,
    "timestamp": 1692123456.789
  }
}

// 受信（サーバー → Godot）
{
  "type": "player_positions",
  "room_id": "room_123", 
  "data": {
    "players": [
      {
        "user_id": "user_789",
        "username": "Bob", 
        "position": {"x": 15.0, "y": 0.0, "z": 8.0},
        "rotation": {"x": 0.0, "y": 0.0, "z": 0.0},
        "animation_state": 0,
        "timestamp": 1692123456.800
      }
    ]
  }
}
"""

# --- プレイヤーアクション同期 ---
class PlayerActionSync:
	var user_id: String
	var action_type: String     # "wave", "dance", "sit", "jump"
	var target_position: Vector3 # アクション対象位置
	var duration: float
	var timestamp: float
	var room_id: String

# WebSocketメッセージ例
"""
// 送信
{
  "type": "player_action",
  "room_id": "room_123",
  "user_id": "user_456",
  "data": {
    "action_type": "wave",
    "target_position": {"x": 12.0, "y": 0.0, "z": 6.0},
    "duration": 2.5,
    "timestamp": 1692123456.789
  }
}

// 受信
{
  "type": "player_action_broadcast",
  "room_id": "room_123",
  "data": {
    "user_id": "user_789",
    "username": "Bob",
    "action_type": "dance", 
    "timestamp": 1692123456.800
  }
}
"""

# --- リアルタイムチャット ---
class RealtimeChatMessage:
	var user_id: String
	var username: String
	var message: String
	var room_id: String
	var timestamp: int
	var message_type: String    # "normal", "system", "private"

# WebSocketメッセージ例
"""
// 送信
{
  "type": "chat_message",
  "room_id": "room_123", 
  "user_id": "user_456",
  "data": {
    "message": "こんにちは！",
    "message_type": "normal",
    "timestamp": 1692123456
  }
}

// 受信
{
  "type": "chat_message_broadcast",
  "room_id": "room_123",
  "data": {
    "user_id": "user_789",
    "username": "Bob",
    "message": "よろしくお願いします！",
    "message_type": "normal", 
    "timestamp": 1692123457
  }
}
"""

# --- ルーム状態変更 ---
class RoomStateSync:
	var room_id: String
	var event_type: String      # "member_joined", "member_left", "room_created"
	var user_id: String
	var username: String
	var additional_data: Dictionary

# WebSocketメッセージ例
"""
// メンバー参加
{
  "type": "room_member_joined",
  "room_id": "room_123",
  "data": {
    "user_id": "user_456",
    "username": "Alice",
    "character_id": 2,
    "permission": "VISITOR"
  }
}

// メンバー退室
{
  "type": "room_member_left", 
  "room_id": "room_123",
  "data": {
    "user_id": "user_456",
    "username": "Alice"
  }
}

// ルーム招待
{
  "type": "room_invitation",
  "data": {
    "room_id": "room_456",
    "room_name": "Alice's Room",
    "inviter_id": "user_123",
    "inviter_name": "Alice",
    "invitee_id": "user_789"
  }
}
"""

# --- マップ移動通知 ---
class MapTransitionSync:
	var user_id: String
	var from_map: String
	var to_map: String
	var to_room_id: String
	var timestamp: float

# WebSocketメッセージ例
"""
// 送信
{
  "type": "map_transition",
  "user_id": "user_456",
  "data": {
    "from_map": "MainTown",
    "to_map": "ForestArea", 
    "to_room_id": "room_forest_01",
    "timestamp": 1692123456.789
  }
}
"""

# ============================================================================
# 📁 実装での使用例
# ============================================================================

# scripts/singletons/Net.gd での実装例
"""
extends Node

# GraphQL通信
func graphql_query(query: String, variables: Dictionary = {}, callback: Callable = Callable()):
    var http_request = HTTPRequest.new()
    add_child(http_request)
    
    var headers = [
        "Content-Type: application/json",
        "Authorization: Bearer " + Game.auth_token
    ]
    
    var body = JSON.stringify({
        "query": query,
        "variables": variables
    })
    
    http_request.request_completed.connect(_on_graphql_response.bind(callback, http_request))
    http_request.request(SERVER_CONFIG.graphql_url, headers, HTTPClient.METHOD_POST, body)

# WebSocket通信
func send_websocket_message(message: Dictionary):
    if websocket and websocket.get_ready_state() == WebSocketPeer.STATE_OPEN:
        var json_message = JSON.stringify(message)
        websocket.send_text(json_message)

func _on_websocket_message_received(message: String):
    var data = JSON.parse_string(message)
    if data == null:
        return
    
    match data.type:
        "player_positions":
            _handle_player_positions(data)
        "chat_message_broadcast":
            _handle_chat_message(data)
        "room_member_joined":
            _handle_room_member_joined(data)
        # ... その他のメッセージタイプ
"""

# scripts/player/PlayerSync.gd での実装例
"""
extends Node

var sync_timer: Timer
var last_position: Vector3
var last_rotation: Vector3

func _ready():
    sync_timer = Timer.new()
    sync_timer.wait_time = 0.1  # 100ms間隔で同期
    sync_timer.timeout.connect(_send_position_update)
    sync_timer.autostart = true
    add_child(sync_timer)

func _send_position_update():
    var player = get_parent()
    var current_position = player.global_position
    var current_rotation = player.global_rotation
    
    # 位置が変化した場合のみ送信
    if current_position.distance_to(last_position) > 0.1 or 
       current_rotation.distance_to(last_rotation) > 0.1:
        
        var sync_data = PlayerPositionSync.new()
        sync_data.user_id = Game.current_user.user_id
        sync_data.position = current_position
        sync_data.rotation = current_rotation
        sync_data.animation_state = player.animation_controller.get_current_animation_state()
        sync_data.timestamp = Time.get_time_dict_from_system()
        sync_data.room_id = Rooms.get_current_room().room_id
        
        Net.send_websocket_message({
            "type": "player_position_update",
            "room_id": sync_data.room_id,
            "user_id": sync_data.user_id,
            "data": sync_data.to_dict()
        })
        
        last_position = current_position
        last_rotation = current_rotation
"""

# ============================================================================
# 🔧 データ最適化のポイント
# ============================================================================

# 1. 送信頻度制限
# - 位置同期: 100ms間隔（10fps）
# - アニメーション: 状態変化時のみ
# - チャット: ユーザー入力時のみ

# 2. 差分送信
# - 前回から変化があった場合のみ送信
# - 閾値設定（0.1m以上の移動、0.1ラジアン以上の回転）

# 3. ルーム分離
# - 各ルーム内でのみ同期
# - 不要なデータの受信を避ける

# 4. 圧縮・最適化
# - Vector3をfloat配列として送信
# - タイムスタンプの統一フォーマット
# - 不要フィールドの省略