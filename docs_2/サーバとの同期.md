# ============================================================================
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŒæœŸãƒ‡ãƒ¼ã‚¿ä»•æ§˜
# GraphQLï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰ vs WebSocketï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼‰
# ============================================================================

# ============================================================================
# ğŸ“Š GraphQL - é™çš„ãƒ‡ãƒ¼ã‚¿ï¼ˆHTTPé€šä¿¡ï¼‰
# ============================================================================

# --- èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ---
class AuthData:
	var token: String           # JWTãƒˆãƒ¼ã‚¯ãƒ³
	var user_id: String
	var username: String
	var email: String
	var character_id: int       # é¸æŠä¸­ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
	var created_at: String
	var last_login: String

# GraphQLã‚¯ã‚¨ãƒªä¾‹
"""
query GetUserInfo($token: String!) {
  user_info(token: $token) {
    user_id
    username
    email
    character_id
    last_login
  }
}

mutation UpdateUserCharacter($user_id: String!, $character_id: Int!) {
  update_user_character(user_id: $user_id, character_id: $character_id) {
    success
  }
}
"""

# --- ãƒ«ãƒ¼ãƒ æƒ…å ± ---
class RoomStaticData:
	var room_id: String
	var room_name: String
	var room_type: String       # "PUBLIC", "PRIVATE", "GROUP"
	var owner_id: String
	var description: String
	var map_scene_path: String
	var max_players: int
	var is_password_protected: bool
	var created_at: String

# GraphQLã‚¯ã‚¨ãƒªä¾‹
"""
query GetRooms {
  public_rooms {
    room_id
    room_name
    description
    current_players
    max_players
    map_scene_path
  }
  
  user_private_rooms(user_id: $user_id) {
    room_id
    room_name
    owner_id
  }
}

mutation CreatePrivateRoom($input: CreateRoomInput!) {
  create_private_room(input: $input) {
    success
    room_info { room_id room_name }
    error_message
  }
}
"""

# --- ç ”ä¿®ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ ---
class TrainingData:
	var training_id: String
	var title: String
	var url: String             # å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãURL
	var category: String
	var difficulty: String
	var estimated_time: int     # åˆ†

class TrainingProgressData:
	var user_id: String
	var training_id: String
	var status: String          # "not_started", "in_progress", "completed"
	var score: int
	var completed_at: String

# GraphQLã‚¯ã‚¨ãƒªä¾‹
"""
query GetTrainingList($user_id: String!) {
  trainings {
    training_id
    title
    url
    category
    difficulty
    estimated_time
  }
  
  user_progress(user_id: $user_id) {
    training_id
    status
    score
    completed_at
  }
}

mutation UpdateTrainingProgress($input: TrainingProgressInput!) {
  update_training_progress(input: $input) {
    success
  }
}
"""

# --- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆåˆæœŸå–å¾—ã®ã¿ï¼‰ ---
class ChatHistoryData:
	var messages: Array[Dictionary] # éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´
	var room_id: String
	var limit: int = 50

# GraphQLã‚¯ã‚¨ãƒªä¾‹  
"""
query GetChatHistory($room_id: String!, $limit: Int!) {
  chat_history(room_id: $room_id, limit: $limit) {
    user_id
    username
    message
    timestamp
    message_type
  }
}
"""

# ============================================================================
# ğŸ”„ WebSocket - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆåŒæ–¹å‘é€šä¿¡ï¼‰
# ============================================================================

# --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ãƒ»çŠ¶æ…‹åŒæœŸ ---
class PlayerPositionSync:
	var user_id: String
	var position: Vector3
	var rotation: Vector3
	var velocity: Vector3       # ç§»å‹•äºˆæ¸¬ç”¨
	var animation_state: int    # AnimationStates.State
	var timestamp: float
	var room_id: String

# WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
"""
// é€ä¿¡ï¼ˆGodot â†’ ã‚µãƒ¼ãƒãƒ¼ï¼‰
{
  "type": "player_position_update",
  "room_id": "room_123",
  "user_id": "user_456",
  "data": {
    "position": {"x": 10.5, "y": 0.0, "z": 5.2},
    "rotation": {"x": 0.0, "y": 1.57, "z": 0.0},
    "velocity": {"x": 0.0, "y": 0.0, "z": 2.5},
    "animation_state": 1,
    "timestamp": 1692123456.789
  }
}

// å—ä¿¡ï¼ˆã‚µãƒ¼ãƒãƒ¼ â†’ Godotï¼‰
{
  "type": "player_positions",
  "room_id": "room_123", 
  "data": {
    "players": [
      {
        "user_id": "user_789",
        "username": "Bob", 
        "position": {"x": 15.0, "y": 0.0, "z": 8.0},
        "rotation": {"x": 0.0, "y": 0.0, "z": 0.0},
        "animation_state": 0,
        "timestamp": 1692123456.800
      }
    ]
  }
}
"""

# --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åŒæœŸ ---
class PlayerActionSync:
	var user_id: String
	var action_type: String     # "wave", "dance", "sit", "jump"
	var target_position: Vector3 # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯¾è±¡ä½ç½®
	var duration: float
	var timestamp: float
	var room_id: String

# WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
"""
// é€ä¿¡
{
  "type": "player_action",
  "room_id": "room_123",
  "user_id": "user_456",
  "data": {
    "action_type": "wave",
    "target_position": {"x": 12.0, "y": 0.0, "z": 6.0},
    "duration": 2.5,
    "timestamp": 1692123456.789
  }
}

// å—ä¿¡
{
  "type": "player_action_broadcast",
  "room_id": "room_123",
  "data": {
    "user_id": "user_789",
    "username": "Bob",
    "action_type": "dance", 
    "timestamp": 1692123456.800
  }
}
"""

# --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ ---
class RealtimeChatMessage:
	var user_id: String
	var username: String
	var message: String
	var room_id: String
	var timestamp: int
	var message_type: String    # "normal", "system", "private"

# WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
"""
// é€ä¿¡
{
  "type": "chat_message",
  "room_id": "room_123", 
  "user_id": "user_456",
  "data": {
    "message": "ã“ã‚“ã«ã¡ã¯ï¼",
    "message_type": "normal",
    "timestamp": 1692123456
  }
}

// å—ä¿¡
{
  "type": "chat_message_broadcast",
  "room_id": "room_123",
  "data": {
    "user_id": "user_789",
    "username": "Bob",
    "message": "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼",
    "message_type": "normal", 
    "timestamp": 1692123457
  }
}
"""

# --- ãƒ«ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ›´ ---
class RoomStateSync:
	var room_id: String
	var event_type: String      # "member_joined", "member_left", "room_created"
	var user_id: String
	var username: String
	var additional_data: Dictionary

# WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
"""
// ãƒ¡ãƒ³ãƒãƒ¼å‚åŠ 
{
  "type": "room_member_joined",
  "room_id": "room_123",
  "data": {
    "user_id": "user_456",
    "username": "Alice",
    "character_id": 2,
    "permission": "VISITOR"
  }
}

// ãƒ¡ãƒ³ãƒãƒ¼é€€å®¤
{
  "type": "room_member_left", 
  "room_id": "room_123",
  "data": {
    "user_id": "user_456",
    "username": "Alice"
  }
}

// ãƒ«ãƒ¼ãƒ æ‹›å¾…
{
  "type": "room_invitation",
  "data": {
    "room_id": "room_456",
    "room_name": "Alice's Room",
    "inviter_id": "user_123",
    "inviter_name": "Alice",
    "invitee_id": "user_789"
  }
}
"""

# --- ãƒãƒƒãƒ—ç§»å‹•é€šçŸ¥ ---
class MapTransitionSync:
	var user_id: String
	var from_map: String
	var to_map: String
	var to_room_id: String
	var timestamp: float

# WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
"""
// é€ä¿¡
{
  "type": "map_transition",
  "user_id": "user_456",
  "data": {
    "from_map": "MainTown",
    "to_map": "ForestArea", 
    "to_room_id": "room_forest_01",
    "timestamp": 1692123456.789
  }
}
"""

# ============================================================================
# ğŸ“ å®Ÿè£…ã§ã®ä½¿ç”¨ä¾‹
# ============================================================================

# scripts/singletons/Net.gd ã§ã®å®Ÿè£…ä¾‹
"""
extends Node

# GraphQLé€šä¿¡
func graphql_query(query: String, variables: Dictionary = {}, callback: Callable = Callable()):
    var http_request = HTTPRequest.new()
    add_child(http_request)
    
    var headers = [
        "Content-Type: application/json",
        "Authorization: Bearer " + Game.auth_token
    ]
    
    var body = JSON.stringify({
        "query": query,
        "variables": variables
    })
    
    http_request.request_completed.connect(_on_graphql_response.bind(callback, http_request))
    http_request.request(SERVER_CONFIG.graphql_url, headers, HTTPClient.METHOD_POST, body)

# WebSocketé€šä¿¡
func send_websocket_message(message: Dictionary):
    if websocket and websocket.get_ready_state() == WebSocketPeer.STATE_OPEN:
        var json_message = JSON.stringify(message)
        websocket.send_text(json_message)

func _on_websocket_message_received(message: String):
    var data = JSON.parse_string(message)
    if data == null:
        return
    
    match data.type:
        "player_positions":
            _handle_player_positions(data)
        "chat_message_broadcast":
            _handle_chat_message(data)
        "room_member_joined":
            _handle_room_member_joined(data)
        # ... ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
"""

# scripts/player/PlayerSync.gd ã§ã®å®Ÿè£…ä¾‹
"""
extends Node

var sync_timer: Timer
var last_position: Vector3
var last_rotation: Vector3

func _ready():
    sync_timer = Timer.new()
    sync_timer.wait_time = 0.1  # 100msé–“éš”ã§åŒæœŸ
    sync_timer.timeout.connect(_send_position_update)
    sync_timer.autostart = true
    add_child(sync_timer)

func _send_position_update():
    var player = get_parent()
    var current_position = player.global_position
    var current_rotation = player.global_rotation
    
    # ä½ç½®ãŒå¤‰åŒ–ã—ãŸå ´åˆã®ã¿é€ä¿¡
    if current_position.distance_to(last_position) > 0.1 or 
       current_rotation.distance_to(last_rotation) > 0.1:
        
        var sync_data = PlayerPositionSync.new()
        sync_data.user_id = Game.current_user.user_id
        sync_data.position = current_position
        sync_data.rotation = current_rotation
        sync_data.animation_state = player.animation_controller.get_current_animation_state()
        sync_data.timestamp = Time.get_time_dict_from_system()
        sync_data.room_id = Rooms.get_current_room().room_id
        
        Net.send_websocket_message({
            "type": "player_position_update",
            "room_id": sync_data.room_id,
            "user_id": sync_data.user_id,
            "data": sync_data.to_dict()
        })
        
        last_position = current_position
        last_rotation = current_rotation
"""

# ============================================================================
# ğŸ”§ ãƒ‡ãƒ¼ã‚¿æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ
# ============================================================================

# 1. é€ä¿¡é »åº¦åˆ¶é™
# - ä½ç½®åŒæœŸ: 100msé–“éš”ï¼ˆ10fpsï¼‰
# - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: çŠ¶æ…‹å¤‰åŒ–æ™‚ã®ã¿
# - ãƒãƒ£ãƒƒãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æ™‚ã®ã¿

# 2. å·®åˆ†é€ä¿¡
# - å‰å›ã‹ã‚‰å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã¿é€ä¿¡
# - é–¾å€¤è¨­å®šï¼ˆ0.1mä»¥ä¸Šã®ç§»å‹•ã€0.1ãƒ©ã‚¸ã‚¢ãƒ³ä»¥ä¸Šã®å›è»¢ï¼‰

# 3. ãƒ«ãƒ¼ãƒ åˆ†é›¢
# - å„ãƒ«ãƒ¼ãƒ å†…ã§ã®ã¿åŒæœŸ
# - ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ã‚’é¿ã‘ã‚‹

# 4. åœ§ç¸®ãƒ»æœ€é©åŒ–
# - Vector3ã‚’floaté…åˆ—ã¨ã—ã¦é€ä¿¡
# - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
# - ä¸è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çœç•¥