# 📚 Week 3: 複数シーンの操作

## 🔄 1. 複雑なシーン遷移パターンの実装

### **実際のゲームに近いシーン構成を作る**

```
ゲームの流れ：
TitleScreen → SettingsScreen → GameScreen → ResultScreen → TitleScreen
     ↑              ↓              ↓            ↓           ↑
     ←──────────────←──────────────←────────────←─────────←
```

## 🎮 実習1: 本格的なゲームフロー作成

### **シーン構成全体像**
```
📁 MultiSceneGame/
├── TitleScreen.tscn        # タイトル画面
├── SettingsScreen.tscn     # 設定画面  
├── GameScreen.tscn         # ゲーム画面
└── ResultScreen.tscn       # 結果画面
```

### **TitleScreen.tscn - タイトル画面**

```
TitleScreen (Control)
├── GameTitle (Label) "私のゲーム"
├── PlayerNameInput (LineEdit) "名前を入力"
├── StartButton (Button) "ゲーム開始"  
├── SettingsButton (Button) "設定"
└── QuitButton (Button) "終了"
```

```gdscript
# TitleScreen.gd
extends Control

# タイトル画面で管理したいデータ
var player_name = ""
var last_score = 0
var total_play_count = 0
var favorite_color = "青"

func _ready():
    print("🎮 タイトル画面開始")
    print("前回のスコア: ", last_score, " を表示したい...")
    print("プレイ回数: ", total_play_count, " を表示したい...")
    
    # UIに前回のデータを表示したいけど...できない
    var info_text = "ようこそ！\n"
    info_text += "前回のスコア: ??? (取得できません)\n" 
    info_text += "プレイ回数: ??? (取得できません)"
    
    # ボタン接続
    $StartButton.pressed.connect(_on_start_pressed)
    $SettingsButton.pressed.connect(_on_settings_pressed) 
    $QuitButton.pressed.connect(_on_quit_pressed)

func _on_start_pressed():
    player_name = $PlayerNameInput.text
    if player_name == "":
        player_name = "無名プレイヤー"
    
    print("=== ゲーム開始 ===")
    print("プレイヤー名: ", player_name)
    print("このデータをゲーム中で使いたい...")
    
    get_tree().change_scene_to_file("res://GameScreen.tscn")

func _on_settings_pressed():
    print("設定画面へ移動（データは保持したい）")
    get_tree().change_scene_to_file("res://SettingsScreen.tscn")

func _on_quit_pressed():
    get_tree().quit()

func _exit_tree():
    print("💀 タイトル画面削除")
    print("player_name: '", player_name, "' 削除")
    print("favorite_color: '", favorite_color, "' 削除")
```

### **SettingsScreen.tscn - 設定画面**

```
SettingsScreen (Control)
├── Title (Label) "設定"
├── VolumeLabel (Label) "音量"
├── VolumeSlider (HSlider) min=0, max=100, value=50
├── DifficultyLabel (Label) "難易度"  
├── DifficultyOption (OptionButton) "Easy,Normal,Hard"
├── ColorLabel (Label) "好きな色"
├── ColorInput (LineEdit) "色を入力"
├── SaveButton (Button) "設定保存"
└── BackButton (Button) "戻る"
```

```gdscript
# SettingsScreen.gd
extends Control

# 設定データ（本来はゲーム全体で共有したい）
var master_volume = 50.0
var difficulty = "Normal"  
var player_color = "青"
var sound_enabled = true
var auto_save = true

func _ready():
    print("⚙️ 設定画面開始")
    
    # 前の設定値を復元したいけど...できない
    print("前回の音量設定: ??? (取得できません)")
    print("前回の難易度: ??? (取得できません)")
    
    # デフォルト値を設定
    $VolumeSlider.value = master_volume
    $DifficultyOption.add_item("Easy")
    $DifficultyOption.add_item("Normal") 
    $DifficultyOption.add_item("Hard")
    $DifficultyOption.selected = 1  # Normal
    
    # ボタン接続
    $SaveButton.pressed.connect(_on_save_pressed)
    $BackButton.pressed.connect(_on_back_pressed)

func _on_save_pressed():
    # 設定を更新
    master_volume = $VolumeSlider.value
    difficulty = $DifficultyOption.get_item_text($DifficultyOption.selected)
    player_color = $ColorInput.text
    
    print("=== 設定保存 ===")
    print("音量: ", master_volume)  
    print("難易度: ", difficulty)
    print("好きな色: ", player_color)
    print("この設定を他の画面でも使いたい...")
    
    # 音量を実際に適用
    var volume_db = linear_to_db(master_volume / 100.0)
    AudioServer.set_bus_volume_db(AudioServer.get_bus_index("Master"), volume_db)

func _on_back_pressed():
    print("タイトルに戻ります（設定は保持したい）")
    get_tree().change_scene_to_file("res://TitleScreen.tscn")

func _exit_tree():
    print("💀 設定画面削除")
    print("master_volume: ", master_volume, " 削除")
    print("difficulty: '", difficulty, "' 削除")  
    print("player_color: '", player_color, "' 削除")
```

### **GameScreen.tscn - ゲーム画面**

```
GameScreen (Control)
├── PlayerInfo (Label) "プレイヤー: ???"
├── ScoreLabel (Label) "スコア: 0"
├── TimeLabel (Label) "時間: 0"
├── ClickButton (Button) "クリックしてスコア獲得"
├── PauseButton (Button) "一時停止"
└── FinishButton (Button) "ゲーム終了"
```

```gdscript
# GameScreen.gd  
extends Control

# ゲーム中のデータ
var player_name = "???"  # タイトル画面から取得したいけどできない
var current_score = 0
var play_time = 0.0
var difficulty = "???"   # 設定画面から取得したいけどできない
var click_count = 0

# ゲーム状態
var is_paused = false
var game_timer: Timer

func _ready():
    print("🎯 ゲーム画面開始")
    print("プレイヤー名を表示したい: ", player_name)
    print("設定した難易度を適用したい: ", difficulty)
    
    # 取得できないデータの代替表示
    $PlayerInfo.text = "プレイヤー: " + player_name + " (取得できませんでした)"
    
    # ゲームタイマー開始
    game_timer = Timer.new()
    game_timer.wait_time = 0.1
    game_timer.autostart = true  
    game_timer.timeout.connect(_on_timer_timeout)
    add_child(game_timer)
    
    # ボタン接続
    $ClickButton.pressed.connect(_on_click_button_pressed)
    $PauseButton.pressed.connect(_on_pause_pressed)
    $FinishButton.pressed.connect(_on_finish_pressed)

func _on_click_button_pressed():
    click_count += 1
    
    # 難易度に応じてスコア変動させたいけど、difficulty が分からない
    var score_gain = 10  # 本来は難易度で変えたい
    current_score += score_gain
    
    $ScoreLabel.text = "スコア: " + str(current_score)
    $ClickButton.text = "クリック! (" + str(click_count) + "回)"

func _on_timer_timeout():
    if not is_paused:
        play_time += 0.1
        $TimeLabel.text = "時間: " + str(int(play_time)) + "秒"

func _on_pause_pressed():
    is_paused = !is_paused
    $PauseButton.text = "再開" if is_paused else "一時停止"

func _on_finish_pressed():
    print("=== ゲーム終了 ===")
    print("最終スコア: ", current_score)
    print("プレイ時間: ", play_time, "秒") 
    print("クリック回数: ", click_count)
    print("プレイヤー名: ", player_name)
    print("このデータを結果画面で表示したい...")
    
    get_tree().change_scene_to_file("res://ResultScreen.tscn")

func _exit_tree():
    print("💀 ゲーム画面削除")
    print("current_score: ", current_score, " 削除")
    print("play_time: ", play_time, " 削除")
    print("click_count: ", click_count, " 削除")
```

### **ResultScreen.tscn - 結果画面**

```
ResultScreen (Control)
├── Title (Label) "結果発表"
├── ResultDisplay (RichTextLabel) "結果表示エリア"
├── HighScoreLabel (Label) "最高記録: ???"
├── PlayAgainButton (Button) "もう一度"
└── TitleButton (Button) "タイトルへ"
```

```gdscript
# ResultScreen.gd
extends Control

# 結果画面で表示したいデータ（でも取得できない）
var final_score = 0      # ゲーム画面から取得したい
var final_time = 0.0     # ゲーム画面から取得したい  
var player_name = "???"  # タイトル画面から取得したい
var click_count = 0      # ゲーム画面から取得したい

# 統計データ（本来は蓄積したい）
var high_score = 0
var total_games = 0
var average_score = 0.0

func _ready():
    print("🏆 結果画面開始")
    print("表示したいデータが全て取得できません...")
    
    # 結果表示（データが無いので悲しい表示）
    var result_text = "[font_size=20]ゲーム結果[/font_size]\n\n"
    result_text += "プレイヤー: " + player_name + " (不明)\n"
    result_text += "スコア: " + str(final_score) + " (不明)\n" 
    result_text += "プレイ時間: " + str(final_time) + "秒 (不明)\n"
    result_text += "クリック数: " + str(click_count) + " (不明)\n\n"
    result_text += "[color=red]前の画面のデータが取得できませんでした😢[/color]"
    
    $ResultDisplay.text = result_text
    $HighScoreLabel.text = "最高記録: " + str(high_score) + " (不明)"
    
    # ボタン接続
    $PlayAgainButton.pressed.connect(_on_play_again_pressed)
    $TitleButton.pressed.connect(_on_title_pressed)

func _on_play_again_pressed():
    print("ゲーム画面に戻ります（また最初から）")
    get_tree().change_scene_to_file("res://GameScreen.tscn")

func _on_title_pressed():  
    print("タイトル画面に戻ります（結果は失われる）")
    get_tree().change_scene_to_file("res://TitleScreen.tscn")

func _exit_tree():
    print("💀 結果画面削除")
    print("high_score などの統計データも削除...")
```

## 😱 2. 複雑なデータ消失パターンの体験

### **実習2: 設定の度重なる消失**

**体験シナリオ：**
1. **設定画面で音量を80に設定** → 保存
2. **タイトルに戻る** → 音量設定が50に戻ってる
3. **再度設定画面** → また最初から設定し直し
4. **ゲーム開始** → 設定した難易度が適用されない
5. **結果画面** → 何も記録されない

```gdscript
# この体験を通して学習者が感じること：

😊 「設定を変更、保存完了！」
😕 「あれ？戻ったら設定が元に戻ってる...」
😰 「えー、毎回設定し直すの？」  
😫 「これじゃゲームとして成り立たない」
🤔 「どうやって設定を保持すればいいの？」
```

## 🔄 3. より複雑な遷移パターン

### **実習3: 循環的な画面遷移での累積問題**

```gdscript
# 学習者に体験してもらう流れ
TitleScreen (プレイヤー名入力: "太郎")
    ↓
SettingsScreen (音量: 80, 難易度: Hard)  
    ↓
GameScreen (スコア: 150点獲得)
    ↓
ResultScreen (データ表示不可)
    ↓  
TitleScreen (前回データ表示不可)
    ↓
SettingsScreen (設定リセット)
    ↓
GameScreen (難易度不明、プレイヤー名不明)
    ↓
...無限ループの困り感...
```

### **学習者の感情変化:**

```
1周目: 「面白そう！」
2周目: 「あれ？データが...」  
3周目: 「毎回最初からって...」
4周目: 「これはダメだ、解決策が必要」
5周目: 「もうやりたくない」← この感情が重要
```

## 💡 4. 現実的な問題の実感

### **実用ゲームでこの問題があったら:**

```
RPGゲーム:
❌ レベルアップしても街に戻るとレベル1
❌ 装備を買っても戦闘画面で装備なし
❌ ストーリー進行がメニューで確認不可

パズルゲーム:  
❌ ハイスコアが記録されない
❌ ステージクリア状況がリセット
❌ 設定した操作方法が毎回戻る

マルチプレイヤーゲーム:
❌ ログインしても他の画面で誰だか分からない
❌ チャット画面と設定画面でユーザー名が違う
❌ ルーム移動でプレイヤー情報消失
```

## 🎯 Week 3 理解度チェック

### **体験すべき困りポイント**
```
✅ 設定画面で設定→タイトルで消失→また設定
✅ 名前入力→ゲーム中に「???」表示  
✅ スコア獲得→結果画面で「不明」表示
✅ 毎回同じ作業の繰り返し
✅ 「これじゃゲームにならない」という実感
```

### **技術的理解ポイント**
```
✅ change_scene_to_file()の正確な使い方
✅ 複数シーン間での遷移方法
✅ _exit_tree()でのデータ削除確認  
✅ シーン間でデータ共有できない制限
✅ この問題がゲーム開発の根本問題であること
```

## 🎯 Week 3 まとめ

**今週の体験:**
- **現実的なゲームフロー** での問題体験
- **設定の繰り返し消失** による苛立ち
- **データ表示不可** による機能不全  
- **ゲームとして成り立たない** 状況の実感

**学習者の心境変化:**
```  
😊 「複数画面のゲームを作ろう！」
😕 「あれ、データが使えない...」
😰 「毎回設定し直すの？」
😫 「これじゃ実用的なゲームが作れない」
🔍 「絶対に解決策があるはず！」
```

**到達目標:**
```
「この問題を解決する方法を知りたい！」
「実用的なゲームを作りたい！」  
「データをシーン間で共有したい！」

→ AutoLoadの学習動機が完全に形成された状態
```

## 🚀 次回予告（Week 4 - AutoLoad登場）

**ついに救世主登場：**
- 「AutoLoadという解決策があります」
- 「全ての問題が一気に解決」
- 「え？こんなに簡単に？」という驚き
- 「最初からこれを知りたかった！」

**実習内容:**
- 今週の4つのシーンにAutoLoadを適用
- データが正常に共有されることの確認
- 「魔法のような問題解決」の体験

---

**現在の状況確認：**
Week 3の実習をやってみて、どの程度「困り感」を体験できましたか？
「これは確かに困る」「解決策が必要だ」と感じましたか？

この感情が強いほど、Week 4でのAutoLoad学習効果が高くなります！