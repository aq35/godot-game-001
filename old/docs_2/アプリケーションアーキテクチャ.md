# 🏗️ Godot 3Dマルチプレイヤーゲーム アーキテクチャ

## 📁 プロジェクト全体構造

```
ProjectRoot/
├── project.godot                    # プロジェクト設定
├── export_presets.cfg              # エクスポート設定
├── override.cfg                    # ローカル設定（gitignore対象）
│
├── autoload/                       # AutoLoadシングルトン
│   ├── Game.gd                     # ゲーム全体状態管理
│   ├── Net.gd                      # ネットワーク通信
│   ├── Audio.gd                    # 音声管理
│   ├── Chat.gd                     # チャットシステム
│   ├── Rooms.gd                    # ルーム管理
│   └── Settings.gd                 # 設定管理
│
├── assets/                         # 静的リソース
│   ├── characters/                 # キャラクター関連
│   │   ├── models/
│   │   │   ├── character_01.glb
│   │   │   ├── character_02.glb
│   │   │   ├── character_03.glb
│   │   │   └── character_04.glb
│   │   ├── textures/
│   │   │   ├── character_01_diffuse.png
│   │   │   └── character_01_normal.png
│   │   └── animations/
│   │       └── character_animations.tres
│   │
│   ├── environments/               # 環境関連
│   │   ├── models/
│   │   │   ├── town_buildings.glb
│   │   │   ├── forest_props.glb
│   │   │   └── beach_environment.glb
│   │   ├── textures/
│   │   │   ├── grass_diffuse.png
│   │   │   └── stone_normal.png
│   │   └── materials/
│   │       ├── grass_material.tres
│   │       └── water_material.tres
│   │
│   ├── ui/                         # UI関連
│   │   ├── icons/
│   │   │   ├── character_icons/
│   │   │   ├── ui_icons/
│   │   │   └── room_icons/
│   │   ├── themes/
│   │   │   ├── main_ui_theme.tres
│   │   │   └── chat_theme.tres
│   │   └── fonts/
│   │       ├── ui_font_regular.ttf
│   │       └── ui_font_bold.ttf
│   │
│   └── audio/                      # 音声ファイル
│       ├── bgm/
│       │   ├── town_theme.ogg
│       │   ├── forest_theme.ogg
│       │   └── menu_theme.ogg
│       └── sfx/
│           ├── ui_sounds/
│           ├── footsteps/
│           └── ambient/
│
├── scenes/                         # シーンファイル
│   ├── main/                       # メインシーン
│   │   ├── Main.tscn               # ゲーム起動シーン
│   │   └── Main.gd
│   │
│   ├── player/                     # プレイヤー関連
│   │   ├── Player.tscn             # 自分のプレイヤー
│   │   ├── Player.gd
│   │   ├── RemotePlayer.tscn       # 他プレイヤー
│   │   ├── RemotePlayer.gd
│   │   ├── PlayerCamera.tscn       # プレイヤーカメラ
│   │   ├── PlayerCamera.gd
│   │   └── components/
│   │       ├── NameTag.tscn        # 名前表示
│   │       ├── NameTag.gd
│   │       ├── PlayerAnimator.tscn # アニメーション制御
│   │       └── PlayerAnimator.gd
│   │
│   ├── worlds/                     # 世界・マップ
│   │   ├── MainTown.tscn
│   │   ├── MainTown.gd
│   │   ├── ForestArea.tscn
│   │   ├── ForestArea.gd
│   │   ├── BeachArea.tscn
│   │   ├── BeachArea.gd
│   │   ├── private_rooms/
│   │   │   ├── PrivateRoomBase.tscn
│   │   │   ├── PrivateRoomBase.gd
│   │   │   ├── StandardRoom.tscn
│   │   │   └── StandardRoom.gd
│   │   └── components/
│   │       ├── MapPortal.tscn      # マップ移動
│   │       ├── MapPortal.gd
│   │       ├── SpawnPoint.tscn     # スポーン地点
│   │       ├── SpawnPoint.gd
│   │       ├── InteractArea.tscn   # インタラクション
│   │       └── InteractArea.gd
│   │
│   ├── ui/                         # ユーザーインターフェース
│   │   ├── screens/                # 全画面UI
│   │   │   ├── LoginScreen.tscn
│   │   │   ├── LoginScreen.gd
│   │   │   ├── CharacterSelect.tscn
│   │   │   ├── CharacterSelect.gd
│   │   │   ├── LoadingScreen.tscn
│   │   │   ├── LoadingScreen.gd
│   │   │   ├── SettingsScreen.tscn
│   │   │   └── SettingsScreen.gd
│   │   │
│   │   ├── hud/                    # ゲーム内HUD
│   │   │   ├── MainHUD.tscn        # メインHUD
│   │   │   ├── MainHUD.gd
│   │   │   ├── ChatPanel.tscn      # チャットパネル
│   │   │   ├── ChatPanel.gd
│   │   │   ├── RoomPanel.tscn      # ルーム情報
│   │   │   ├── RoomPanel.gd
│   │   │   ├── TrainingMenu.tscn   # 研修メニュー
│   │   │   └── TrainingMenu.gd
│   │   │
│   │   ├── dialogs/                # ダイアログ
│   │   │   ├── ConfirmDialog.tscn
│   │   │   ├── ConfirmDialog.gd
│   │   │   ├── CreateRoomDialog.tscn
│   │   │   ├── CreateRoomDialog.gd
│   │   │   ├── InviteDialog.tscn
│   │   │   ├── InviteDialog.gd
│   │   │   ├── ErrorDialog.tscn
│   │   │   └── ErrorDialog.gd
│   │   │
│   │   └── components/             # 再利用UIコンポーネント
│   │       ├── UserCard.tscn       # ユーザー情報カード
│   │       ├── UserCard.gd
│   │       ├── RoomListItem.tscn   # ルームリスト項目
│   │       ├── RoomListItem.gd
│   │       ├── ChatMessage.tscn    # チャットメッセージ
│   │       ├── ChatMessage.gd
│   │       ├── CharacterPreview.tscn # キャラプレビュー
│   │       └── CharacterPreview.gd
│   │
│   └── effects/                    # エフェクト・パーティクル
│       ├── PlayerSpawnEffect.tscn
│       ├── PlayerSpawnEffect.gd
│       ├── ChatBubble.tscn
│       ├── ChatBubble.gd
│       └── particles/
│           ├── WarpEffect.tscn
│           └── WarpEffect.gd
│
├── scripts/                        # スクリプト（シーン以外）
│   ├── core/                       # コアシステム
│   │   ├── Constants.gd            # 定数定義
│   │   ├── GameTypes.gd            # データ型定義
│   │   ├── AnimationStates.gd      # アニメーション状態
│   │   ├── Utils.gd                # ユーティリティ関数
│   │   ├── SaveSystem.gd           # セーブ・ロードシステム
│   │   └── EventBus.gd             # イベントバス（グローバルシグナル）
│   │
│   ├── network/                    # ネットワーク関連
│   │   ├── GraphQLClient.gd        # GraphQLクライアント
│   │   ├── WebSocketClient.gd      # WebSocketクライアント
│   │   ├── NetworkMessages.gd      # メッセージ定義
│   │   ├── AuthManager.gd          # 認証管理
│   │   └── SyncManager.gd          # 同期管理
│   │
│   ├── player/                     # プレイヤーロジック
│   │   ├── PlayerController.gd     # プレイヤー制御
│   │   ├── PlayerSync.gd           # プレイヤー同期
│   │   ├── AnimationController.gd  # アニメーション制御
│   │   ├── CharacterSelector.gd    # キャラクター選択
│   │   └── InputHandler.gd         # 入力処理
│   │
│   ├── rooms/                      # ルーム関連
│   │   ├── RoomManager.gd          # ルーム管理
│   │   ├── RoomData.gd             # ルームデータ
│   │   ├── MemberManager.gd        # メンバー管理
│   │   └── InviteSystem.gd         # 招待システム
│   │
│   ├── chat/                       # チャット関連
│   │   ├── ChatManager.gd          # チャット管理
│   │   ├── MessageFormatter.gd     # メッセージ整形
│   │   ├── ChatHistory.gd          # 履歴管理
│   │   └── ChatUI.gd               # チャットUI制御
│   │
│   ├── training/                   # 研修システム
│   │   ├── TrainingManager.gd      # 研修管理
│   │   ├── TrainingData.gd         # 研修データ
│   │   ├── ProgressTracker.gd      # 進捗追跡
│   │   └── BrowserLauncher.gd      # ブラウザ起動
│   │
│   └── ui/                         # UI制御スクリプト
│       ├── UIController.gd         # UI全体制御
│       ├── ScreenManager.gd        # 画面遷移管理
│       ├── DialogManager.gd        # ダイアログ管理
│       ├── NotificationManager.gd  # 通知管理
│       └── components/
│           ├── UIAnimator.gd       # UIアニメーション
│           ├── ListController.gd   # リスト制御
│           └── FormValidator.gd    # フォーム検証
│
├── data/                           # データファイル
│   ├── config/                     # 設定ファイル
│   │   ├── server_config.json      # サーバー設定
│   │   ├── character_list.json     # キャラクターリスト
│   │   ├── animation_config.json   # アニメーション設定
│   │   ├── room_templates.json     # ルームテンプレート
│   │   └── ui_config.json          # UI設定
│   │
│   ├── localization/               # 多言語対応
│   │   ├── ja.po                   # 日本語
│   │   └── en.po                   # 英語
│   │
│   └── cache/                      # キャッシュデータ
│       ├── .gitkeep
│       └── README.md
│
├── addons/                         # Godotアドオン
│   ├── custom_networking/          # カスタムネットワーキング
│   └── ui_extensions/              # UI拡張
│
├── tools/                          # 開発ツール
│   ├── build_scripts/              # ビルドスクリプト
│   ├── asset_pipeline/             # アセット処理
│   └── debugging/                  # デバッグツール
│
├── tests/                          # テストファイル
│   ├── unit/                       # ユニットテスト
│   ├── integration/                # 統合テスト
│   └── test_helpers/               # テストヘルパー
│
└── docs/                           # プロジェクト文書
    ├── architecture.md             # アーキテクチャ文書
    ├── api_reference.md            # API仕様
    ├── setup_guide.md              # セットアップガイド
    └── contributing.md             # 貢献ガイド
```

## 🔧 AutoLoad設定（Project Settings）

```
Game        - autoload/Game.gd          # ゲーム状態管理
Net         - autoload/Net.gd           # ネットワーク通信  
Audio       - autoload/Audio.gd         # 音声管理
Chat        - autoload/Chat.gd          # チャットシステム
Rooms       - autoload/Rooms.gd         # ルーム管理
Settings    - autoload/Settings.gd      # 設定管理
EventBus    - scripts/core/EventBus.gd  # グローバルイベント
```

## 📋 命名規則・コーディング規約

### **ファイル命名**
- **シーンファイル**: PascalCase (例: `MainTown.tscn`, `PlayerCamera.tscn`)
- **スクリプトファイル**: PascalCase (例: `PlayerController.gd`, `ChatManager.gd`)  
- **アセットファイル**: snake_case (例: `character_01.glb`, `town_theme.ogg`)

### **クラス・変数命名**
- **クラス名**: PascalCase (例: `PlayerController`, `RoomManager`)
- **変数名**: snake_case (例: `current_user`, `is_connected`)
- **定数名**: UPPER_SNAKE_CASE (例: `MAX_PLAYERS`, `SERVER_URL`)
- **シグナル名**: 過去形 (例: `player_moved`, `room_joined`)

### **ディレクトリ構造の原則**
- **機能別分類**: 関連機能をディレクトリにグループ化
- **階層化**: 深すぎない適度な階層構造（最大4-5層）
- **責任分離**: 単一責任の原則に従った分類
- **再利用性**: 共通コンポーネントの明確な分離

## 🔄 アーキテクチャパターン

### **レイヤー構造**
1. **Presentation Layer** (UI/HUD/Screens)
2. **Application Layer** (AutoLoad Singletons) 
3. **Domain Layer** (Core Business Logic)
4. **Infrastructure Layer** (Network/Storage/External)

### **通信フロー**
```
UI Components → AutoLoad Singletons → Network Layer → Server
             ←                      ←              ←
```

### **状態管理**
- **グローバル状態**: AutoLoadシングルトンで管理
- **ローカル状態**: 各シーン/コンポーネントで管理  
- **イベント通信**: EventBusパターンでデカップリング

### **データフロー**
```
Server Data → Network Layer → AutoLoad → UI Update
User Input → UI → AutoLoad → Network Layer → Server
```

## 📐 設計原則

### **SOLID原則**
- **単一責任**: 各クラスは一つの責任のみ
- **開放閉鎖**: 拡張に開いて修正に閉じている
- **依存関係逆転**: 具象ではなく抽象に依存

### **Godot特有のベストプラクティス**
- **シーンベース設計**: 機能をシーン単位で分割
- **ノード構成最適化**: 必要最小限のノード構成
- **シグナル活用**: ノード間通信にシグナルを使用
- **AutoLoad適切利用**: グローバル状態管理に限定使用

## 🎯 拡張ポイント

### **新キャラクター追加**
1. `assets/characters/models/` に新モデル追加
2. `data/config/character_list.json` に定義追加
3. 自動的にキャラ選択に反映

### **新マップ追加**  
1. `scenes/worlds/` に新シーン作成
2. `BaseMap.gd` を継承して実装
3. ポータルシステムで自動連携

### **新UI追加**
1. 適切な`scenes/ui/`サブディレクトリに追加
2. 共通コンポーネントは`components/`で再利用
3. `ScreenManager.gd`で画面遷移管理

このアーキテクチャで開発の準備完了です！