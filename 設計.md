了解！
**2Dは“設定専用エリア”**、\*\*3Dは“世界”\*\*に特化する前提で、Godot 4 のアーキテクチャとシーン構成を最小でまとめます。
（＝2Dにロビー/キャラ/移動は不要。UI＝設定画面のみ）

---

# 全体像（役割分離）

* **3D：World**

  * 実際に遊ぶ空間・アバター・カメラ・当たり判定・チャット表示。
* **2D：Settings（設定UI）**

  * プロフィール編集（名前・アバター色など）
  * ルーム選択（個人/共有）
  * ログイン/ログアウト
  * キー割り当て、音量、グラフィクス
* **共通：Autoloadシングルトン**

  * `AppRouter`（遷移・ロード）
  * `AuthStore`（JWT・ログイン状態）
  * `UserProfile`（名前・外観設定）
  * `RoomStore`（現在のルームID・プレゼンス）
  * `Net`（HTTP/WSラッパ）

---

# ルート構成（常駐UI + 差し替えステージ）

```
App.tscn (Node)
├─ CanvasLayer:UI         ← 2Dの“設定UI”はここ（常駐）
│  ├─ TopBar (Control)    ← 歯車ボタン、ルーム選択、ログイン状態
│  ├─ SettingsPanel (Control)   ← 設定ウィンドウ（表示/非表示）
│  └─ ChatOverlay (Control)     ← チャット（必要なら常駐）
└─ Stage (Node)           ← 3Dワールドを差し込む場所
```

**ポイント**

* 2Dは**CanvasLayer配下のUIだけ**。
* 3Dは `Stage` の子として**ひとつだけ**ロード/差し替え。
* 設定はポップアップ/ドロワーで開閉（3Dから即アクセス）。

---

# 3Dワールド（例）

```
World3D.tscn (Node3D)
├─ Environment (WorldEnvironment)
├─ Player3D (CharacterBody3D)
│  ├─ Camera3D
│  ├─ AnimationTree
│  └─ Mesh/Skins...
├─ NavigationRegion3D / Collisions
└─ SpawnPoints / Interactables
```

---

# Autoload（Project Settings → Autoload で登録）

**AppRouter.gd**（3D差し替え＆フェード）

```gdscript
extends Node
const WORLD_SCENE := preload("res://scenes/three_d/World3D.tscn")
@onready var stage: Node = get_tree().get_root().get_node("App/Stage")

func goto_world(room_id: String = "lobby") -> void:
    _swap(WORLD_SCENE.instantiate().tap(func(n): n.set("room_id", room_id)))

func _swap(new_scene: Node) -> void:
    for c in stage.get_children(): c.queue_free()
    stage.add_child(new_scene)
```

**AuthStore.gd**（最小）

```gdscript
extends Node
var token: String = ""
var user_id: String = ""
func is_logged_in() -> bool: return token != ""
```

**UserProfile.gd**（設定UIが編集する）

```gdscript
extends Node
var display_name := "Guest"
var avatar_color := Color(0.9,0.9,0.9)
signal profile_changed()
func set_name(n:String)->void: display_name = n; emit_signal("profile_changed")
func set_color(c:Color)->void: avatar_color = c; emit_signal("profile_changed")
```

**RoomStore.gd**（現在ルーム）

```gdscript
extends Node
var current_room_id := "lobby"
signal room_changed(id:String)
func set_room(id:String): current_room_id = id; emit_signal("room_changed", id)
```

**Net.gd**（HTTP/WSラッパ雛形）

```gdscript
extends Node
var ws: WebSocketPeer
func connect_ws(url:String, token:String) -> void:
    ws = WebSocketPeer.new()
    ws.connect_to_url("%s?token=%s" % [url, token])
    # pollはWorld3D側の_processで実行
func send_json(obj:Dictionary) -> void:
    if ws and ws.get_ready_state() == WebSocketPeer.STATE_OPEN:
        ws.send_text(JSON.stringify(obj))
```

---

# 設定UI（2D・CanvasLayer配下）

**TopBar（右上の歯車ボタン）**

```gdscript
# TopBar.gd
extends Control
@onready var settings_panel: Control = $"../SettingsPanel"
func _on_settings_button_pressed(): settings_panel.visible = !settings_panel.visible
```

**SettingsPanel（設定の中身例）**

* タブ：プロフィール / ルーム / アカウント / 入力 / オーディオ / グラフィクス
* フォームを `UserProfile` と `RoomStore`、`AuthStore` に**バインド**するだけ。**3Dは触らない**。

```gdscript
# SettingsPanel.gd
extends Control
@onready var name_edit: LineEdit = %NameEdit
@onready var color_picker: ColorPickerButton = %ColorPicker
func _ready():
    name_edit.text = UserProfile.display_name
    color_picker.color = UserProfile.avatar_color
func _on_name_changed(new_text:String): UserProfile.set_name(new_text)
func _on_color_changed(c:Color): UserProfile.set_color(c)
func _on_room_select(id:String): RoomStore.set_room(id); AppRouter.goto_world(id)
func _on_login(): AuthStore.token = "dummy"; # 実装ではHTTP
func _on_logout(): AuthStore.token = ""; AppRouter.goto_world("lobby")
```

---

# 3D側は“設定の購読者”

**Player3D.gd**（見た目だけ設定を反映）

```gdscript
extends CharacterBody3D
@onready var mesh: MeshInstance3D = %Mesh
func _ready():
    UserProfile.profile_changed.connect(_apply_profile)
    _apply_profile()
func _apply_profile():
    var mat := mesh.get_active_material(0)
    if mat: mat.set("albedo_color", UserProfile.avatar_color) # PBRなら適宜
```

> ※共有マテリアルを変更すると全員に波及するので、必要なら**Make Unique**してから色を変える。

**World3D.gd**（ネット・チャット・ルーム連携）

```gdscript
extends Node3D
@export var room_id := "lobby"
func _ready():
    RoomStore.set_room(room_id)
    # Net.connect_ws(...); 初期同期・プレゼンス購読など
```

---

# 入力とUI

* 設定UIは**ゲーム入力と分離**（`Control` がフォーカス中は移動入力を無効にする）。
* `Esc` で設定の開閉、`Enter` でチャット送信などの**共通ショートカット**を `CanvasLayer` にまとめる。

---

# ルームの考え方

* Settings で選んだルームIDを `RoomStore` に設定 → `AppRouter.goto_world(room_id)` で**3D差し替え**。
* ルーム間の移動は**常に設定側（2D UI）から指示**する方針でOK（ワールド内ポータル無しでも良い）。

---

# 永続化

* 設定（名前・色・音量など）は

  * ローカル：`ConfigFile`（起動時に読み込み、閉じるとき保存）
  * サーバ：`PATCH /profile` でミラー（ログイン時）

---

# 実装順（最短）

1. `App.tscn` + `CanvasLayer:UI` + `Stage`
2. `SettingsPanel`（名前・色・ルーム選択・ログイン/ログアウトダミー）
3. `World3D.tscn`（シンプルな床 + Player3D の移動）
4. `Player3D` が `UserProfile` を購読して色反映
5. `RoomStore` と `AppRouter` でルーム差し替え
6. （任意）`ChatOverlay` と `Net` のWS雛形

---

この形なら、**2D＝設定の司令塔、3D＝遊ぶ場**がクリーンに分かれます。
必要なら、`SettingsPanel.tscn` のUIレイアウト（Controlツリー）や、`ConfigFile` 保存コード、WSの最小サンプルも出します。どこから書き始めますか？
