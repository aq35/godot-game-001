いいね、その方向で進めよう！
「**手書きで作れる最小構成**」として、まず“定義すべきもの”を**チェックリスト化**しました。これだけ作れば、ログイン→メニュー→ノート保存→3Dルーム入室（チャット送受信の骨格）まで一周できます。

---

# 1) ディレクトリとファイル（まず用意）

```
res://autoload/
  App.gd
  Auth.gd
  Api.gd
  NotesStore.gd
  RoomClient.gd
  UserPrefs.gd
  UiBus.gd

res://scenes/ui/
  Login.tscn
  Login.gd
  MainMenu.tscn
  MainMenu.gd
  Notes.tscn
  Notes.gd
  TrainingList.tscn
  TrainingList.gd

res://scenes/room/
  Room3D.tscn
  Room3D.gd
  Player.tscn         （空でもOK／後で差し替え）
  RemotePlayer.tscn   （空でもOK）

res://game.tscn       （最上位：Node だけでもOK）
```

> まずは **空シーンでもOK**。後から差し替えやすい名前で置くのがコツ。

---

# 2) Project Settings（UI から or 手書きで）

## AutoLoad（シングルトンにするスクリプト）

```
App           -> res://autoload/App.gd
Auth          -> res://autoload/Auth.gd
Api           -> res://autoload/Api.gd
NotesStore    -> res://autoload/NotesStore.gd
RoomClient    -> res://autoload/RoomClient.gd
UserPrefs     -> res://autoload/UserPrefs.gd
UiBus         -> res://autoload/UiBus.gd
```

## Input Map（最低限）

* `move_forward` : W / JoyUp(-1)
* `move_back`    : S / JoyDown(+1)
* `move_left`    : A / JoyLeft(-1)
* `move_right`   : D / JoyRight(+1)
* `jump`         : Space / Joypad A(0)
* `sprint`       : Shift
* `chat_send`    : Enter
* `toggle_fullscreen` : F11

> 既存の `move_up/down/left/right` をこの4つに寄せてもOK（どちらでも可）。

---

# 3) 最小コード（そのまま貼って動く骨格）

## autoload/App.gd

```gdscript
extends Node
var _current: Node
func _ready():
    change_scene("res://scenes/ui/Login.tscn")
func change_scene(path: String):
    if _current:
        remove_child(_current); _current.queue_free()
    _current = load(path).instantiate()
    add_child(_current)
```

## autoload/Auth.gd

```gdscript
extends Node
signal logged_in
signal logged_out
var jwt := ""
var user := {}
func login(name: String, password: String) -> void:
    var res = await Api.post_json("/auth/login", {"name":name,"password":password})
    if res.ok:
        jwt = res.body.get("jwt",""); user = res.body.get("user",{})
        emit_signal("logged_in")
    else:
        push_error(res.error)
func logout():
    jwt = ""; user = {}; emit_signal("logged_out")
```

## autoload/Api.gd

```gdscript
extends Node
const BASE := "https://example.com/api"
func _headers()->PackedStringArray:
    var h = ["Content-Type: application/json"]
    if Auth.jwt != "": h.append("Authorization: Bearer %s" % Auth.jwt)
    return h
func post_json(path:String, body:Dictionary)->Dictionary:
    var http := HTTPRequest.new(); add_child(http)
    http.request("%s%s" % [BASE,path], _headers(), HTTPClient.METHOD_POST, JSON.stringify(body))
    var r = await http.request_completed; http.queue_free(); return _parse(r)
func get_json(path:String)->Dictionary:
    var http := HTTPRequest.new(); add_child(http)
    http.request("%s%s" % [BASE,path], _headers(), HTTPClient.METHOD_GET)
    var r = await http.request_completed; http.queue_free(); return _parse(r)
func _parse(r)->Dictionary:
    var code = r[1]; var body_txt = r[3]; var obj = {}
    if body_txt != "" and JSON.is_valid(body_txt): obj = JSON.parse_string(body_txt)
    return {"ok": code>=200 and code<300, "code": code, "body": obj, "error": obj.get("message","http %s" % code)}
```

## autoload/NotesStore.gd

```gdscript
extends Node
const DIR := "user://notes"; const FILE := "user://notes/index.json"
var notes: Array = []
func _ready():
    DirAccess.make_dir_recursive_absolute(DIR); load_all()
func load_all():
    if not FileAccess.file_exists(FILE): notes=[]; _save(); return
    var f = FileAccess.open(FILE, FileAccess.READ); notes = JSON.parse_string(f.get_as_text()) or []; f.close()
func _save():
    var f = FileAccess.open(FILE, FileAccess.WRITE); f.store_string(JSON.stringify(notes,"\t")); f.close()
func list()->Array: return notes
func save_note(n:Dictionary)->void:
    var i = notes.find(notes.filter(func(x): return x.id==n.id).front() if notes.size()>0 else null)
    if i == -1: notes.append(n) else: notes[i] = n; _save()
```

## autoload/RoomClient.gd（同期の“形”だけ）

```gdscript
extends Node
@onready var mp := MultiplayerAPI.new()
var url := "wss://example.com/room"; var connected := false
func connect_room():
    if connected: return
    var peer := WebSocketMultiplayerPeer.new()
    if peer.create_client(url) != OK: push_error("ws connect failed"); return
    mp.multiplayer_peer = peer; get_tree().set_multiplayer(mp); connected = true
@rpc("unreliable_ordered")
func sync_move(id:int, pos:Vector3, rot_y:float, state:String):
    UiBus.emit_signal("remote_move", id, pos, rot_y, state)
func send_move(id,pos,rot_y,state): rpc_unreliable("sync_move", id,pos,rot_y,state)
@rpc func broadcast_chat(sender:String, msg:String):
    UiBus.emit_signal("chat_message", sender, msg)
func send_chat(msg:String): rpc("broadcast_chat", Auth.user.get("name",""), msg)
```

## autoload/UserPrefs.gd

```gdscript
extends Node
const CFG := "user://prefs.cfg"
var volume_sfx:=0.8; var volume_bgm:=0.6; var lang:="ja"
func load_prefs():
    var c:=ConfigFile.new(); if c.load(CFG)==OK:
        volume_sfx=c.get_value("audio","sfx",volume_sfx)
        volume_bgm=c.get_value("audio","bgm",volume_bgm)
        lang=c.get_value("ui","lang",lang)
func save_prefs():
    var c:=ConfigFile.new()
    c.set_value("audio","sfx",volume_sfx); c.set_value("audio","bgm",volume_bgm)
    c.set_value("ui","lang",lang); c.save(CFG)
```

## autoload/UiBus.gd

```gdscript
extends Node
signal toast(msg)
signal chat_message(sender, msg)
signal remote_move(id, pos, rot_y, state)
```

---

# 4) シーン側の最小スクリプト

## scenes/ui/Login.gd

```gdscript
extends CanvasLayer
@onready var username = %username
@onready var password = %password
func _ready(): Auth.logged_in.connect(_on_logged_in)
func _on_logged_in(): App.change_scene("res://scenes/ui/MainMenu.tscn")
func _on_Login_button_pressed(): Auth.login(username.text, password.text)
```

## scenes/ui/MainMenu.gd

```gdscript
extends CanvasLayer
func _on_Training_pressed(): App.change_scene("res://scenes/ui/TrainingList.tscn")
func _on_Notes_pressed(): App.change_scene("res://scenes/ui/Notes.tscn")
func _on_Room_pressed(): App.change_scene("res://scenes/room/Room3D.tscn")
func _on_Settings_pressed(): UserPrefs.save_prefs()
func _on_Logout_pressed(): Auth.logout(); App.change_scene("res://scenes/ui/Login.tscn")
```

## scenes/ui/TrainingList.gd

```gdscript
extends CanvasLayer
@onready var list := %ItemList
func _ready():
    var r = await Api.get_json("/trainings")
    if r.ok:
        list.clear()
        for t in r.body: list.add_item("%s" % t.get("title","(no title)"))
        list.set_meta("data", r.body)
func _on_Open_in_Browser_pressed():
    var data:Array = list.get_meta("data"); if data.is_empty(): return
    var idx = list.get_selected_items(); if idx.is_empty(): return
    OS.shell_open(data[idx[0]].get("url","https://example.com"))
```

## scenes/ui/Notes.gd

```gdscript
extends CanvasLayer
@onready var titles := %ItemList
@onready var title := %LineEdit
@onready var body := %TextEdit
var current_id := ""
func _ready(): _refresh()
func _refresh():
    titles.clear(); for n in NotesStore.list(): titles.add_item(n.title)
func _on_titles_item_selected(i):
    var n = NotesStore.list()[i]; current_id=n.id; title.text=n.title; body.text=n.body
func _on_Save_pressed():
    if current_id=="": current_id=str(Time.get_unix_time_from_system())
    NotesStore.save_note({"id":current_id,"title":title.text,"body":body.text,"images":[],"updated_at":Time.get_datetime_string_from_system()})
    _refresh()
```

## scenes/room/Room3D.gd

```gdscript
extends Node3D
@onready var chat_input := %ChatInput
@onready var chat_log := %ChatLog
func _ready():
    RoomClient.connect_room()
    UiBus.chat_message.connect(_on_chat)
func _on_chat(sender, msg): chat_log.append_text("[b]%s[/b]: %s\n" % [sender, msg])
func _on_ChatInput_text_submitted(t):
    if t.strip_edges()!="": RoomClient.send_chat(t); chat_input.clear()
```

> ノード名（`%username` など）は **シーン側で同じ名前** にしておけばOK。
> シグナルは Button の `pressed()` を各 `_on_*_pressed` に結線、LineEdit の `text_submitted` を `Room3D.gd` へ結線。

---

# 5) 最小ノード配置（文字でメモれる形）

* **Login.tscn**: `CanvasLayer` → `Panel` → `LineEdit(name=username)`, `LineEdit(name=password, secret=true)`, `Button(text="Login")`
* **MainMenu.tscn**: `CanvasLayer` → `VBoxContainer` → `Button("Training")`, `Button("Notes")`, `Button("Room")`, `Button("Settings")`, `Button("Logout")`
* **Notes.tscn**: `CanvasLayer` → `HSplitContainer`
  左: `ItemList` / 右: `VBox` → `LineEdit(name=title)`, `TextEdit(name=body)`, `Button("Save")`
* **TrainingList.tscn**: `CanvasLayer` → `Panel` → `ItemList`, `Button("Open in Browser")`
* **Room3D.tscn**: `Node3D` → `WorldEnvironment`, `DirectionalLight3D`, `CanvasLayer` → `VBox` → `RichTextLabel(name=ChatLog)`, `LineEdit(name=ChatInput)`

---

# 6) 動かす順序（チェック）

1. AutoLoad 登録（7個）
2. `game.tscn` の root に **Node** を置いて（空でOK）`run/main_scene` を `res://game.tscn` に設定
3. `App.gd` が `Login.tscn` を開くことを確認
4. `Login → MainMenu` 遷移（Auth.logged\_in シグナルで）
5. `Notes` で保存 → `user://notes/index.json` ができる
6. `Room3D` でチャット送信（WSは仮でもOK。まずは `UiBus.emit_signal("chat_message","me","hello")` を手動で呼んで見えれば合格）

---

## 迷ったらここから

* まずは **Login.tscn / MainMenu.tscn / Notes.tscn** の3つと、`App.gd / UiBus.gd / NotesStore.gd` の3ファイルだけで一周。
* その後に `TrainingList` → `Room3D` を足す。

必要なら、上の各 `*.tscn` を\*\*手書き（TSNテキスト）\*\*版で出します。
次はどの画面から作る？（おすすめは Login → MainMenu → Notes）
